<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Creative Lab Prompt</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom Styles for Aesthetics and Responsiveness */
        :root {
            --bg-color: #0d1117;
            --card-color: #161b22;
            --border-color: #30363d;
            --text-color: #c9d1d9;
            --primary-color: #3b82f6; /* blue-500 */
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            min-height: 100vh;
        }
        .scrollable-category {
            max-height: 250px;
            overflow-y: auto;
            border-radius: 8px;
            padding: 10px;
            background-color: var(--card-color);
            border: 1px solid var(--border-color);
        }
        /* Custom Scrollbar for dark theme */
        .scrollable-category::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        .scrollable-category::-webkit-scrollbar-thumb {
            background: #555;
            border-radius: 4px;
        }
        .scrollable-category::-webkit-scrollbar-track {
            background: #222;
        }
        .pill.selected {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
            color: white;
            box-shadow: 0 4px 6px rgba(59, 130, 246, 0.3);
        }
        .pill:hover {
            opacity: 0.8;
            cursor: pointer;
        }
        .status-message {
            padding: 1rem;
            border-radius: 0.5rem;
            margin-top: 1rem;
            display: flex;
            align-items: flex-start; /* Changed to flex-start for better multi-line content */
            flex-direction: column;
        }
        .status-error {
            background-color: #fca5a5; /* Red-300 */
            color: #7f1d1d; /* Red-900 */
            border: 1px solid #ef4444; /* Red-500 */
        }
        .status-success {
            background-color: #a7f3d0; /* Green-300 */
            color: #065f46; /* Green-900 */
            border: 1px solid #10b981; /* Green-500 */
        }
        .hidden {
            display: none !important;
        }
        .card {
            background-color: var(--card-color);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        /* Custom toggle switch style for alignment */
        #promptExpanderToggle:checked ~ .dot {
            transform: translateX(100%);
            background-color: var(--primary-color);
        }
        #promptExpanderToggle:checked ~ .block {
            background-color: #60a5fa; /* blue-400 */
        }
    </style>
</head>
<body class="p-4 sm:p-8">

    <div id="app" class="max-w-7xl mx-auto space-y-8">
        
        <header class="text-center mb-10">
            <h1 class="text-4xl sm:text-5xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-purple-600 mb-2">
                Creative Lab Prompt
            </h1>
            <p class="text-gray-400 text-lg mb-1">A Unified System for AI Image Creation.</p>
            <p class="text-sm text-gray-500">Developed by Diana Modica</p>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <div class="lg:col-span-2 space-y-6">
                
                <div class="card p-6 space-y-4">
                    <h2 class="text-2xl font-semibold text-white">1. Core Vision & Input</h2>
                    <textarea id="basePrompt" rows="4" class="w-full p-4 text-white bg-[#0d1117] border border-gray-700 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150" placeholder="Describe your central subject, scene, or idea. Example: A mighty griffin soaring over a neon-lit futuristic city..."></textarea>
                    
                    <div class="flex flex-col sm:flex-row gap-3">
                        <input type="file" id="imageUpload" accept="image/*" class="file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-purple-500 file:text-white hover:file:bg-purple-600 transition duration-150 text-sm text-gray-500 cursor-pointer w-full">
                        <button id="uploadPromptBtn" onclick="uploadAndGeneratePrompt()" class="w-full sm:w-auto flex-shrink-0 py-2 px-4 bg-purple-700 text-white font-bold rounded-lg hover:bg-purple-800 transition duration-150 shadow-md">
                            Analyze Image & Generate Prompt
                        </button>
                    </div>

                    <div class="pt-4 border-t border-gray-700">
                        <div class="flex justify-between items-center mb-2">
                            <h3 class="text-lg font-medium text-gray-300">Inspiration Prompts</h3>
                            <button onclick="refreshPrompts()" class="text-blue-400 hover:text-blue-500 transition duration-150 text-sm flex items-center">
                                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356-2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                                New Ideas
                            </button>
                        </div>
                        <div id="promptSuggestions" class="space-y-2">
                            </div>
                    </div>
                </div>

                <div class="card p-6 space-y-4">
                     <h2 class="text-2xl font-semibold text-white">2. Generation Settings</h2>

                    <div class="space-y-3">
                        <h3 class="text-lg font-medium text-gray-300">Aspect Ratio</h3>
                        <div id="aspectRatioContainer" class="flex flex-wrap gap-2">
                            </div>
                    </div>
                    
                    <div class="space-y-4 pt-4 border-t border-gray-700">
                        <div class="flex items-center justify-start">
                            <label for="promptExpanderToggle" class="flex items-center cursor-pointer">
                                <div class="relative">
                                    <input type="checkbox" id="promptExpanderToggle" class="sr-only" checked>
                                    <div class="block bg-gray-600 w-14 h-8 rounded-full transition"></div>
                                    <div class="dot absolute left-1 top-1 bg-white w-6 h-6 rounded-full transition"></div>
                                </div>
                                <div class="ml-3 text-white font-medium">
                                    AI Prompt Expander (Recommended)
                                </div>
                            </label>
                        </div>

                        <div class="flex justify-center">
                            <button id="generateBtn" onclick="generateArt()" class="w-full px-8 py-3 bg-green-600 text-white text-xl font-bold rounded-xl hover:bg-green-700 transition duration-150 shadow-lg shadow-green-900/50">
                                GENERATE AI ART
                            </button>
                        </div>
                    </div>

                </div>

                <div class="card p-6 space-y-4">
                    <h2 class="text-2xl font-semibold text-white">3. Prompt Modifiers (Select to refine)</h2>
                    <p class="text-sm text-gray-400">Select powerful modifiers. *Artist, Style, Lighting, and **Output Format** are exclusive choices.* Use the 'Add' feature to permanently save your custom options.</p>
                    
                    <div id="loadingCategories" class="p-4 text-center text-gray-500">
                        Loading modifiers from your personal vault...
                    </div>
                    <div id="categoryContainer" class="space-y-6">
                        </div>
                </div>

                <div class="card p-6">
                    <div class="flex justify-center">
                        <button id="generateBtnBottom" onclick="generateArt()" class="w-full px-8 py-3 bg-green-600 text-white text-xl font-bold rounded-xl hover:bg-green-700 transition duration-150 shadow-lg shadow-green-900/50">
                            GENERATE AI ART
                        </button>
                    </div>
                </div>

            </div>
            
            <div class="lg:col-span-1 space-y-6">
                
                <div id="statusMessage" class="status-message hidden">
                    </div>

                <div class="card p-4 flex flex-col items-center justify-center min-h-[400px]">
                    <h2 class="text-xl font-semibold text-white mb-4">Generated Image</h2>
                    
                    <div id="loadingIndicator" class="hidden flex flex-col items-center justify-center h-full w-full">
                        <svg class="animate-spin h-10 w-10 text-blue-500 mb-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <p id="loadingTip" class="text-gray-400 text-sm text-center">Initializing power conduits...</p>
                    </div>

                    <img id="generatedImage" class="rounded-lg shadow-xl hidden" style="max-width: 100%; height: auto;" src="https://placehold.co/600x600/161b22/c9d1d9?text=Your+Vision+Manifested" alt="Generated AI Art Placeholder">
                    
                    <div id="placeholderText" class="text-center">
                        <p class="text-gray-500 mt-4">Your masterpiece will appear here.</p>
                    </div>

                    <button id="downloadBtn" onclick="handleDownload()" class="mt-4 px-6 py-2 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 transition duration-150 shadow-md hidden">
                        DOWNLOAD IMAGE (JPG)
                    </button>
                </div>
            </div>

        </div>
    </div>

    <script type="module">
        // --- Firebase Imports ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        // NOTE: Use updateDoc for targeted updates instead of overwriting the whole document with setDoc
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, setLogLevel, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- API Setup (Necessary for Gemini API access) ---
        const apiKey = ""; // API Key is provided by the environment
        const GENERATE_ART_URL = `https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-002:predict?key=${apiKey}`;
        const GENERATE_PROMPT_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
        const EXPANDER_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`; // New URL for prompt expansion
        
        // Global Firebase Variables (Provided by environment)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db;
        let auth;
        let userId = 'loading'; // Will be updated on successful sign-in
        let CATEGORY_DATA = {}; // Dynamic data structure loaded from Firestore
        let selectedOptions = {};
        let currentSamplePrompts = []; // Stores the currently displayed random prompts

        // --- Data storage for image generation ---
        let lastGeneratedJpgBase64Data = null; 
        
        // --- Full Library of Prompts for Randomization ---
        const FULL_PROMPT_LIBRARY = [
            "A lonely space cowboy riding a cosmic horse through a nebula, cinematic lighting, vaporwave style.",
            "An ornate, brass-and-wood steampunk airship docking over a misty Victorian London skyline, hyperdetailed oil painting.",
            "A highly detailed, bioluminescent deep-sea creature swimming through underwater ruins, Rule of Thirds composition.",
            "A post-apocalyptic nature reclaiming a desolate, rusted robot, matte painting, hyperdetailed cinematic.",
            "A futuristic ramen stall illuminated by neon signs in a rainy Tokyo alley, film noir style, moody.",
            "An ancient Greek marble statue shattered by digital glitch effects, with a feeling of chaotic beauty.",
            "A floating celestial library orbiting a purple gas giant, detailed with God rays and ethereal glow.",
            "A tiny cottage nestled inside the roots of a giant, magical tree, drawn by Hayao Miyazaki.",
            "A dynamic portrait of a cyberpunk samurai with chrome armor, rendered in vibrant RGB light.",
            "A majestic griffin soaring over a neon-lit, futuristic Tokyo cityscape, drawn by Syd Mead in the style of vaporwave.",
            "A tiny astronaut standing on a giant, moss-covered ringworld, cold blue moonlight, cinematic dramatic lighting.",
            "A serene and calm portrait of an ancient robotic shaman holding a staff, oil painting style, volumetric lighting.",
            "Post-apocalyptic nature reclaiming a desolate skyscraper, matte painting, hyperdetailed cinematic, melancholy and lonely.",
            "An abstract geometric arrangement of vibrant, glowing jellyfish swimming in a celestial void, prismatic distortion.",
            "A medieval knight facing a massive, spectral dragon in a blizzard, high contrast B&W, extreme close-up.",
            "A tranquil, low-poly 3D scene of a desert oasis at sunrise, with warm golden hour light, rule of thirds.",
            "A photorealistic close-up of a shattered hourglass filled with stardust, deep focus, extreme detail.",
            "An Art Nouveau poster of a woman entwined with luminous flora, inspired by Alphonse Mucha, golden ratio.",
            "A vibrant Pop Art illustration of a comic book hero saving a cat from a falling satellite, dynamic angle.",
            "A desolate, wind-swept beach featuring the ruins of a collapsed space elevator, rendered with film grain and a sepia tone."
        ];


        const ASPECT_RATIOS = [
            { id: '1:1', ratio: '1:1', dimensions: '(Square)', default: true },
            { id: '4:3', ratio: '4:3', dimensions: '(Classic)', default: false },
            { id: '3:4', ratio: '3:4', dimensions: '(Portrait)', default: false },
            { id: '16:9', ratio: '16:9', dimensions: '(Widescreen)', default: false },
            { id: '9:16', ratio: '9:16', dimensions: '(Mobile Story)', default: false }
        ];

        let selectedAspectRatio = ASPECT_RATIOS.find(r => r.default).id;

        // --- Initial Seed Data (Used only once to populate the database) ---
        const SEED_DATA = {
            artist: { 
                title: "Artist Inspiration", 
                prefix: "Art by", 
                options: [
                    "Greg Rutkowski (ArtStation)", "Zdislav Beksinski (Surrealism)", "Alphonse Mucha (Art Nouveau)", 
                    "Hayao Miyazaki (Ghibli)", "Leonardo da Vinci (Renaissance)", "Frank Frazetta (Fantasy)",
                    "Moebius (Sci-Fi Comics)", "Peter Mohrbacher (Angelarium)", "Loish (Digital Portrait)",
                    "Beeple (Digital Abstract)", "Banksy (Street Art)", "H.R. Giger (Biomechanical)",
                    "Claude Monet (Impressionism)", "Victo Ngai (Illustrative)", "Escher (Impossible Geometry)",
                    "Van Gogh (Post-Impressionism)", "Syd Mead (Futurism)", "Klimt (Symbolism)", 
                    "NightCafe Stylized", "Midjourney V6 Aesthetic", "Makoto Shinkai (Anime Landscapes)", 
                    "Ivan Aivazovsky (Seascapes)", "Hokusai (Woodblock)", "Caravaggio (Baroque Tenebrism)", 
                    "James Gurney (Dinotopia)", "Simon Stålenlenhag (Retro Sci-Fi)", "Ghibli Studio Aesthetic", 
                    "Disney Concept Artist", "Pixar Aesthetic", "Chris Foss (Spaceships)", 
                    "John Berkey (Space Art)", "J.C. Leyendecker (Illustration)", "Norman Rockwell (Americana)", 
                    "Albert Bierstadt (Romantic Landscapes)", "William Blake (Symbolism)", "Egon Schiele (Expressionism)", 
                    "Jean-Michel Basquiat (Neo-Expressionism)", "Takashi Murakami (Superflat)", "Yayoi Kusama (Polka Dots)", 
                    "Shepard Fairey (Poster Art)", "Art Deco Master", "Bauhaus Style", "Rococo Elegance", 
                    "Post-Impressionist Master", "Abstract Geometric Artist", "Photorealist Painter", 
                    "Hyperrealist Oil Painter", "Concept Art Sketch Artist", "Matte Painting Digital Master"
                ]
            },
            style: { 
                title: "Art Style", 
                prefix: "in the style of", 
                options: [
                    "Steampunk", "Photorealistic", "Oil Painting", "Abstract Expressionism", "Low-Poly 3D", 
                    "Anime Style", "Ukiyo-e Woodblock", "Voxel Art", "Hyperdetailed Cinematic", 
                    "Synthwave", "Cyberpunk", "Pixel Art", "Charcoal Sketch", "Watercolor",
                    "Matte Painting", "Conceptual Art", "Dystopian Grunge", "Gothic Architecture",
                    "Pop Art", "Film Noir", "Gouache Painting", "Pastel Drawing", "Pencil Sketch", 
                    "Marker Illustration", "Mosaic Art", "Stained Glass", "Holographic", "Glitchcore", 
                    "Vaporwave", "Neo-Expressionist", "Maximalism", "Minimalism", "Brutalist Architecture", 
                    "Trompe-l'oeil", "Daguerreotype Photo", "Wet Plate Collodion", "Cyanotype Print", 
                    "Lithograph", "Etching", "Mecha Design", "Biopunk", "Solarpunk", "Dieselpunk", 
                    "Toy Art", "Graffiti Style", "Mandala Pattern", "Zine Aesthetic", "Paper Craft", 
                    "Claymation", "Pixelated Glitch", "Fluid Dynamics", "Abstract Landscape", "Ink Splatter"
                ]
            },
            mood: { 
                title: "Mood & Emotion", 
                prefix: "with a feeling of", 
                options: [
                    "Eerie and haunting", "Serene and calm", "Chaotic and kinetic", "Melancholy and lonely", 
                    "Joyful and vibrant", "Mysterious and ancient", "Triumphant and bold", "Nostalgic and warm",
                    "Horror and dread", "Whimsical and playful", "Aggressive and sharp", "Tranquil and meditative",
                    "Wondrous and epic", "Dreamlike and hazy", "Intense and dramatic", "Cozy and intimate",
                    "Sublime and powerful", "Desolate and empty", "Hopeful and bright", "Brooding and dark",
                    "Existential dread", "Crystalline clarity", "Electric energy", "Quiet solitude", 
                    "Savage intensity", "Ancient wisdom", "Weightless tranquility", "Heavy atmosphere", 
                    "Bitter defeat", "Tender affection", "Frenetic panic", "Stoic patience", "Wistful longing", 
                    "Chaotic excitement", "Deep satisfaction", "Haunting beauty", "Playful mischief", 
                    "Cold indifference", "Warm embrace", "Spiritual awakening", "Sensory overload", 
                    "Muted reflection", "Bold confrontation", "Subtle threat", "Overwhelming scale"
                ]
            },
            theme: { 
                title: "Theme & Subject Focus", 
                prefix: "with themes of", 
                options: [
                    "Cyberpunk Cityscape", "Deep Sea Exploration", "Ancient Mythology", "Space Opera Adventure", 
                    "Post-Apocalyptic Nature", "Medieval Fantasy Battle", "Haunted Mansion Interior", "Lost Alien Civilization",
                    "Robots in Nature", "Floating Islands", "Time Travel Paradox", "Alchemist's Workshop",
                    "Zen Garden", "Digital Glitchscape", "Cyborg Portrait", "Luminous Flora",
                    "Gilded Age Elegance", "Victorian Sci-Fi", "Cosmic Horror", "Future Fashion",
                    "Norse Mythology", "Japanese Folklore", "Desert Nomads", "Deep Space Anomaly", 
                    "Underwater Ruins", "Bio-luminescent Forest", "Time-Worn Clockwork", "Magitech", 
                    "Floating Marketplace", "Sentinel Robots", "Lost Library", "Post-Human Earth", 
                    "Giant Kaiju", "Secret Garden", "Neon Alleyways", "Volcanic Eruption", 
                    "Arctic Research Base", "Subterranean City", "Aerial View of a Storm", "Inside a Microchip", 
                    "Symbiotic Creatures", "Quantum Entanglement", "Mythical Creature Taxonomy", "Ritualistic Objects", 
                    "Evolving Landscapes", "The Last Human", "Alien Flora", "Haunted Carnival"
                ]
            },
            lighting: { 
                title: "Lighting & Color", 
                prefix: "illuminated by", 
                options: [
                    "Volumetric lighting", "Cinematic dramatic lighting", "God rays", "Rim lighting", 
                    "Neon glow", "Twilight hour", "Studio softbox", "Ethereal glow",
                    "Overcast day", "Harsh sunlight", "Bioluminescent light", "Misty and diffused",
                    "Backlit silhouette", "Warm golden hour", "Cold blue moonlight", "Candlelight flicker",
                    "Vibrant RGB light", "Ultraviolet light", "Chromatic aberration", "Dynamic range HDR",
                    "Spotlight", "Soft Ambient", "Harsh Contrast", "Low Key", "High Key", "Blue Hour", 
                    "Subsurface Scattering", "Fluorescent Tubes", "Muted Palette", "Monochromatic", 
                    "Triadic Colors", "Analog Colors", "Complimentary Colors", "Split-Complementary", 
                    "Warm Tones", "Cool Tones", "Infrared Vision", "X-ray Effect", "Light Pillars", 
                    "Ray Tracing", "Opaque Shadows", "Refraction", "Caustics", "Volumetric Fog", 
                    "Chromatic Spectrum", "High Saturation", "Desaturated", "Muted Colors", "Edge Glow"
                ]
            },
            outputFormat: {
                title: "Output Format & Line Art", 
                prefix: "render as a line drawing", 
                options: [
                    "Black and White Coloring Page, thick lines, ready to print and color", 
                    "Detailed Line Art Illustration, thin lines, no shading, high resolution", 
                    "High-Contrast Pen and Ink Sketch, grayscale, minimalist, print quality",
                    "Vector Outline Drawing, simple shapes, easy to color, black and white"
                ]
            },
            background: { 
                title: "Background & Environment", 
                prefix: "set against a background of", 
                options: [
                    "Bokeh effect", "Vast Nebula cloud", "Simple gradient", "Cracked Earth wasteland", 
                    "Overgrown Ruins", "Distant Mountain Range", "Void of Space", "Dense Jungle canopy",
                    "Flooded City streets", "Mirror Lake reflection", "Infinite White space", "Digital Circuit board",
                    "Steaming Volcano", "Sand Dunes at sunset", "Glacial landscape", "Empty Desert road",
                    "Woven tapestry", "Heavy rain and fog", "Crystal formations", "Abstract geometric pattern",
                    "Distant Metropolis", "Moonlit Ocean", "Infinite Desert", "Dense Fog", 
                    "Abstract Particles", "Corroded Metal", "Winding River", "Crystal Cave", 
                    "Lush Valley", "Tectonic Plates", "Ice Cavern", "Submerged Temple", 
                    "Bamboo Forest", "Snow Covered Tundra", "Shifting Sand Dunes", "Cloud Sea", 
                    "Aurora Borealis", "Gilded Frame", "Wrought Iron Fence", "Moss Covered Stone", 
                    "Electric Storm", "Zero Gravity", "Floating Debris", "Geometric Patterned Tiles", 
                    "Wall of Monitors", "Cracked Glass", "Rainbow Mist", "Cosmic Ripples"
                ]
            },
            filters: { 
                title: "Filters & Post-Processing", 
                prefix: "with effects like", 
                options: [
                    "Film grain", "Sepia tone", "Glitch effect", "Subtle lens flare", 
                    "Vibrant colors", "Sketch lines", "Halftone print", "High contrast B&W",
                    "Anamorphic lens blur", "Double exposure", "Chromatic noise", "Depth of Field (DOF)",
                    "Polaroid photo", "Cross-hatch shading", "Digital oil paint filter", "Aged parchment",
                    "HDR processing", "Soft focus dreamy", "Monochrome cyanotype", "Prismatic distortion",
                    "Tilt-shift", "Fisheye Lens", "Wide Angle", "Telephoto Compression", 
                    "VHS Filter", "Scanline Effect", "Old Film Look", "Grainy Texture", 
                    "Cross Processed", "Bleach Bypass", "Solarized Effect", "Gaussian Blur", 
                    "Motion Blur", "Radial Blur", "Pixel Sorting", "Data Loss Glitch", 
                    "Distorted Geometry", "High Saturation", "Desaturated", "Muted Colors", 
                    "Shallow DOF", "Bokeh", "Edge Glow", "Chromatic Aberration", 
                    "Vignette", "Noise Reduction", "Super Resolution", "Anti-aliasing"
                ]
            },
            composition: { 
                title: "Composition & Angle", 
                prefix: "composed with", 
                options: [
                    "Rule of Thirds", "Golden Ratio spiral", "Dutch Angle tilt", "Perfectly Symmetrical", 
                    "Extreme Close-Up", "Ultra-Wide Shot", "Vertical Pan perspective", "Tilt-Shift miniature",
                    "Leading lines", "Deep focus", "Candid snapshot", "Aerial view",
                    "Worm's-eye view", "Character looking away", "Panoramic landscape", "Macro detail",
                    "Framing (doorway, window)", "Triptych layout", "Negative space emphasis", "Over-the-shoulder shot",
                    "Symmetry", "Asymmetry", "Rule of Odds", "Framing", 
                    "Negative Space", "Golden Spiral", "Triangle Composition", "Dynamic Diagonal", 
                    "Vertical Format", "Horizontal Format", "Close-up Shot", "Extreme Wide Shot", 
                    "Point of View (POV)", "Bird's-Eye View", "Low Angle Shot", "Mid-Shot", 
                    "Full Body Shot", "Action Shot", "Frozen Moment", "Foreground Focus", 
                    "Background Blur", "Juxtaposition", "Repetition", "Pattern Break", 
                    "Silhouette Composition", "Centered Subject", "Off-Center", "Shallow Depth", 
                    "Deep Focus", "Fibonacci Sequence"
                ]
            }
        };

        // --- DOM Elements ---
        const basePromptEl = document.getElementById('basePrompt');
        const generateBtn = document.getElementById('generateBtn');
        const generateBtnBottom = document.getElementById('generateBtnBottom'); // NEW: Added bottom button element
        const uploadPromptBtn = document.getElementById('uploadPromptBtn');
        const generatedImageEl = document.getElementById('generatedImage');
        const downloadBtn = document.getElementById('downloadBtn'); 
        // NOTE: PlaceholderText is now only the text 'Your masterpiece will appear here.'
        const placeholderTextEl = document.getElementById('placeholderText'); 
        const loadingIndicatorEl = document.getElementById('loadingIndicator');
        const loadingTipEl = document.getElementById('loadingTip');
        const statusMessageEl = document.getElementById('statusMessage');
        const categoryContainer = document.getElementById('categoryContainer');
        const aspectRatioContainer = document.getElementById('aspectRatioContainer');
        const imageUploadEl = document.getElementById('imageUpload');
        const loadingCategoriesEl = document.getElementById('loadingCategories');
        const promptSuggestionsEl = document.getElementById('promptSuggestions');
        // New Expander Toggle
        const promptExpanderToggle = document.getElementById('promptExpanderToggle'); 


        // --- Utility Functions ---

        /**
         * Custom Exponential Backoff Fetch function for API calls.
         */
        async function customFetch(url, options, maxRetries = 3) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.status === 429 && i < maxRetries - 1) {
                        const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                        continue;
                    }
                    if (!response.ok) {
                        const errorBody = await response.json();
                        throw new Error(`API Error ${response.status}: ${errorBody.error?.message || 'Unknown error'}`);
                    }
                    return response;
                } catch (error) {
                    if (i === maxRetries - 1) throw error;
                }
            }
        }

        /**
         * Converts a File object to a Base64 encoded string.
         */
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = error => reject(error);
                reader.readAsDataURL(file);
            });
        }
        
        /**
         * Displays status/error messages.
         * @param {string} type - 'error' or 'success'
         * @param {string} message - The message content.
         * @param {number} [duration=15000] - Duration in milliseconds before auto-hiding. Use 0 for no auto-hide.
         */
        function showStatus(type, message, duration = 15000) {
            statusMessageEl.innerHTML = message;
            
            // Reset classes (assumes classes are handled by the HTML structure)
            statusMessageEl.classList.remove('hidden', 'status-error', 'status-success');
            
            // Set type class
            if (type === 'error') {
                statusMessageEl.classList.add('status-error');
            } else {
                statusMessageEl.classList.add('status-success');
            }

            // Hide download button on error
            if (type === 'error') {
                 downloadBtn.classList.add('hidden');
            }

            // Set duration for auto-hide
            if (duration > 0) {
                clearTimeout(statusMessageEl.timeoutId);
                statusMessageEl.timeoutId = setTimeout(() => {
                    statusMessageEl.classList.add('hidden');
                }, duration);
            }
        }

        /**
         * Converts PNG Base64 data (as typically returned by the API) to JPEG Base64 data.
         * @param {string} base64PngData - Base64 string of the PNG image.
         * @returns {Promise<string>} Base64 string of the JPEG image.
         */
        function convertBase64ToJpg(base64PngData) {
            return new Promise((resolve) => {
                const img = new Image();
                // Set the PNG data URL as the image source
                img.src = `data:image/png;base64,${base64PngData}`;

                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    canvas.width = img.width;
                    canvas.height = img.height;
                    const ctx = canvas.getContext('2d');
                    // Ensure black background for transparency conversion, if any (matches dark mode theme)
                    ctx.fillStyle = '#0d1117'; 
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                    ctx.drawImage(img, 0, 0);
                    
                    // Convert canvas content to JPEG base64 string (0.9 is quality)
                    const jpgUrl = canvas.toDataURL('image/jpeg', 0.9);
                    
                    // Extract just the base64 part
                    resolve(jpgUrl.split(',')[1]); 
                };
                img.onerror = () => {
                    // Fallback in case image loading fails, just return the original data.
                    console.error("Failed to load image for JPG conversion. Returning original data.");
                    resolve(base64PngData);
                };
            });
        }


        // --- Firestore Functions ---

        /**
         * Seeds the Firestore database with the initial rich category data.
         */
        async function seedDatabase() {
            // Data is saved to private path: /artifacts/{appId}/users/{userId}/prompt_modifiers/options
            const modifiersDocRef = doc(db, `artifacts/${appId}/users/${userId}/prompt_modifiers/options`);
            
            try {
                const docSnap = await getDoc(modifiersDocRef);
                
                if (!docSnap.exists()) {
                    await setDoc(modifiersDocRef, SEED_DATA);
                    console.log("Database seeded successfully with initial modifier data.");
                    showStatus('success', 'Modifier options loaded and saved to your private database for scaling!', 5000);
                } else {
                    console.log("Modifier data already exists. Skipping seed.");
                }
            } catch (error) {
                console.error("Error seeding database:", error);
                showStatus('error', 'Could not save initial modifier data to the database.', 10000);
            }
        }


        /**
         * Sets up real-time listener for category data from Firestore.
         */
        function subscribeToModifiers() {
            const modifiersDocRef = doc(db, `artifacts/${appId}/users/${userId}/prompt_modifiers/options`);

            onSnapshot(modifiersDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    CATEGORY_DATA = docSnap.data();
                    renderCategories();
                    loadingCategoriesEl.classList.add('hidden');
                } else {
                    console.log("No modifier data found. Seeding database.");
                    seedDatabase();
                }
            }, (error) => {
                console.error("Error loading modifiers:", error);
                showStatus('error', 'Failed to load dynamic modifiers. Check console for details.', 10000);
                loadingCategoriesEl.textContent = 'Failed to load modifiers.';
            });
        }
        
        /**
         * Saves a new modifier option to Firestore and updates the UI.
         * @param {string} categoryKey - The key of the category to update ('artist', 'style', etc.)
         */
        window.addModifier = async (categoryKey) => {
            const inputEl = document.getElementById(`new-modifier-${categoryKey}`);
            let newValue = inputEl.value.trim();

            if (!newValue) {
                showStatus('error', 'Please enter a value before trying to add a new modifier.', 3000);
                return;
            }

            // Capitalize first letter for consistency
            newValue = newValue.charAt(0).toUpperCase() + newValue.slice(1);

            const currentOptions = CATEGORY_DATA[categoryKey]?.options || [];

            if (currentOptions.includes(newValue)) {
                showStatus('error', `"${newValue}" is already in the list for this category.`, 3000);
                inputEl.value = '';
                return;
            }

            const modifiersDocRef = doc(db, `artifacts/${appId}/users/${userId}/prompt_modifiers/options`);
            
            try {
                // Update the array field within the specific category object
                const updatePayload = {};
                // Use a temporary array to build the new list (Firestore array operations aren't ideal here)
                const newOptionsList = [...currentOptions, newValue].sort(); 
                updatePayload[categoryKey] = {
                    ...CATEGORY_DATA[categoryKey],
                    options: newOptionsList
                };
                
                // Use updateDoc to merge the changes without overwriting other categories
                await updateDoc(modifiersDocRef, updatePayload);

                // Clear input and show success message
                inputEl.value = '';
                showStatus('success', `"${newValue}" added and permanently saved to your custom list!`, 4000);
                
            } catch (error) {
                console.error("Error adding modifier:", error);
                showStatus('error', `Failed to save new modifier: ${error.message}`, 10000);
            }
        };


        /**
         * Initializes Firebase and authenticates the user.
         */
        async function initFirebaseAndLoadData() {
            if (!firebaseConfig.apiKey) {
                console.error("Firebase config missing. Cannot initialize Firestore.");
                loadingCategoriesEl.textContent = 'Database setup error.';
                return;
            }

            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                setLogLevel('debug');

                await setPersistence(auth, browserLocalPersistence);

                // Authentication using provided token or anonymous sign-in
                if (initialAuthToken) {
                    const userCredential = await signInWithCustomToken(auth, initialAuthToken);
                    userId = userCredential.user.uid;
                } else {
                    const userCredential = await signInAnonymously(auth);
                    userId = userCredential.user.uid;
                }

                console.log("Firebase initialized. User ID:", userId);
                
                // Load Modifiers from DB
                subscribeToModifiers(); 

                // Initialize Prompts
                refreshPrompts();

            } catch (error) {
                console.error("Firebase authentication failed:", error);
                showStatus('error', 'Authentication failed. Data loading stopped.', 10000);
                loadingCategoriesEl.textContent = 'Authentication error.';
            }
        }

        // --- Prompt Generation and Rendering ---

        /**
         * Selects a specified number of random prompts from the full library.
         * @param {number} count - The number of prompts to select.
         * @returns {string[]} An array of randomly selected prompts.
         */
        function getRandomPrompts(count) {
            const shuffled = [...FULL_PROMPT_LIBRARY]
                .sort(() => 0.5 - Math.random());
            return shuffled.slice(0, count);
        }

        /**
         * Refreshes the list of displayed prompt suggestions.
         */
        window.refreshPrompts = () => {
            currentSamplePrompts = getRandomPrompts(4); // Select 4 random prompts
            renderPromptSuggestions();
            showStatus('success', 'New creative ideas loaded!', 3000);
        };

        /**
         * Renders clickable prompt suggestions based on `currentSamplePrompts`.
         */
        function renderPromptSuggestions() {
            // This function relies on the 'promptSuggestionsEl' DOM element
            promptSuggestionsEl.innerHTML = currentSamplePrompts.map((prompt, index) => `
                <div class="p-3 bg-[#0d1117] rounded-lg border border-[#30363d] cursor-pointer hover:border-blue-500 transition duration-150"
                    onclick="applyPromptSuggestion('${prompt.replace(/'/g, "\\'")}')">
                    <p class="text-sm text-gray-400 truncate">${prompt}</p>
                </div>
            `).join('');
        }
        
        /**
         * Applies a selected prompt suggestion to the main textarea.
         */
        window.applyPromptSuggestion = (promptText) => {
            // This relies on the 'basePromptEl' DOM element
            basePromptEl.value = promptText;
            showStatus('success', 'Prompt loaded! Now adjust the aspect ratio and click GENERATE AI ART.', 5000);
        };


        // --- Initializers & UI Renderers ---

        /**
         * Renders the aspect ratio buttons.
         */
        function renderAspectRatios() {
            // This relies on the 'aspectRatioContainer' DOM element
            aspectRatioContainer.innerHTML = ASPECT_RATIOS.map(ratio => `
                <button
                    id="ratio-${ratio.id.replace(':', '-')}"
                    data-ratio="${ratio.id}"
                    class="p-2 text-sm rounded-lg border transition duration-150 ${ratio.default ? 'bg-blue-600 border-blue-600 text-white' : 'bg-[#30363d] border-[#30363d] text-gray-300 hover:bg-blue-500 hover:border-blue-500'}"
                    onclick="selectAspectRatio('${ratio.id}')">
                    ${ratio.ratio} ${ratio.dimensions}
                </button>
            `).join('');
        }
        window.selectAspectRatio = (ratioId) => {
            selectedAspectRatio = ratioId;
            document.querySelectorAll('#aspectRatioContainer button').forEach(btn => {
                btn.classList.remove('bg-blue-600', 'border-blue-600', 'text-white');
                btn.classList.add('bg-[#30363d]', 'border-[#30363d]', 'text-gray-300');
            });
            document.getElementById(`ratio-${ratioId.replace(':', '-')}`).classList.add('bg-blue-600', 'border-blue-600', 'text-white');
            document.getElementById(`ratio-${ratioId.replace(':', '-')}`).classList.remove('bg-[#30363d]', 'border-[#30363d]', 'text-gray-300');
        };
        
        /**
         * Renders the category pill selectors using data loaded into CATEGORY_DATA, including the new add feature.
         */
        function renderCategories() {
            // This relies on the 'categoryContainer' DOM element
            categoryContainer.innerHTML = Object.entries(CATEGORY_DATA).map(([key, data]) => {
                const optionCount = Array.isArray(data.options) ? data.options.length : 0;
                return `
                    <div class="space-y-3">
                        <h3 class="text-lg font-medium text-white">${data.title} (${optionCount} options)</h3>
                        <div id="pills-${key}" class="scrollable-category flex flex-wrap gap-2 p-2 bg-[#0d1117] rounded-lg border border-[#30363d]">
                            ${Array.isArray(data.options) ? data.options.sort().map(option => `
                                <span class="pill inline-flex items-center px-3 py-1 text-sm font-medium bg-[#30363d] text-gray-300 rounded-full border border-transparent ${selectedOptions[key] && selectedOptions[key].has(option) ? 'selected' : ''}"
                                    data-category="${key}"
                                    data-value="${option}"
                                    onclick="togglePill(this, '${key}', '${option.replace(/'/g, "\\'")}')">
                                    ${option}
                                </span>
                            `).join('') : '<p class="text-gray-500">No options loaded.</p>'}
                        </div>
                        
                        <div class="flex gap-2 pt-2 border-t border-gray-700">
                            <input type="text" id="new-modifier-${key}" placeholder="Type and Add Custom Option" class="flex-grow p-2 text-sm bg-[#0d1117] border border-[#30363d] rounded-lg text-white" 
                                onkeydown="if(event.key === 'Enter') addModifier('${key}')">
                            <button onclick="addModifier('${key}')" class="bg-blue-700 hover:bg-blue-800 text-white font-semibold py-2 px-4 text-sm rounded-lg transition duration-200">
                                Add
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        window.togglePill = (element, category, value) => {
            if (!selectedOptions[category]) {
                selectedOptions[category] = new Set();
            }

            // Exclusive selection for these categories to prevent overly long prompts
            // ADD 'outputFormat' to the exclusive list for coloring book styles
            const exclusiveCategories = ['artist', 'style', 'lighting', 'outputFormat'];
            if (exclusiveCategories.includes(category)) {
                // Clear all others in the category
                const container = document.getElementById(`pills-${category}`);
                container.querySelectorAll('.pill.selected').forEach(el => {
                    if (el !== element) { // Don't deselect the element if it was already selected
                        el.classList.remove('selected');
                    }
                });
                selectedOptions[category].clear();
                
                // If the current element was clicked, it becomes the new selection
                if (!element.classList.contains('selected')) {
                    element.classList.add('selected');
                    selectedOptions[category].add(value);
                } else {
                    // If the user clicks an already selected exclusive pill, deselect it
                    element.classList.remove('selected');
                    selectedOptions[category].delete(value);
                }
            } else {
                // Toggle logic for non-exclusive categories
                if (element.classList.contains('selected')) {
                    element.classList.remove('selected');
                    selectedOptions[category].delete(value);
                } else {
                    element.classList.add('selected');
                    selectedOptions[category].add(value);
                }
            }
        };

        // Initialize UI components
        renderAspectRatios();
        initFirebaseAndLoadData();


        // --- Core Prompt Functions ---

        /**
         * Compiles the final detailed prompt from all inputs.
         * @param {boolean} includeQuality - Whether to append generic quality modifiers. Only true if NOT expanding.
         * @returns {string} The complete prompt string.
         */
        function compilePrompt(includeQuality = true) {
            let parts = [basePromptEl.value.trim()];

            // 1. Add category modifiers
            Object.entries(CATEGORY_DATA).forEach(([key, data]) => {
                if (selectedOptions[key] && selectedOptions[key].size > 0) {
                    const modifiers = Array.from(selectedOptions[key]).join(', ');
                    parts.push(`${data.prefix} ${modifiers}`);
                }
            });

            // 2. Add technical quality modifiers ONLY if expansion is NOT used.
            if (includeQuality) {
                parts.push("ultra quality, professional photography, masterpiece, sharp focus, 8k, photorealistic");
            }

            return parts.filter(p => p).join(', ');
        }
        
        /**
         * Uses Gemini to expand a simple prompt into a highly detailed, professional-grade prompt.
         * @param {string} simplePrompt - The prompt compiled from user input and selected modifiers.
         * @returns {Promise<string>} The highly detailed, expanded prompt.
         */
        async function expandPromptWithGemini(simplePrompt) {
            const systemPrompt = `You are an expert AI image prompt engineer specializing in cinematic, hyper-detailed, and technically perfect descriptions for models like Imagen.
            Your task is to take the user's prompt (which includes style and subject keywords) and expand it into a single, cohesive, long paragraph that is highly complex, precise, and descriptive.
            Crucially, you must:
            1. Elaborate significantly on the subject, setting, and mood using vivid adjectives and scene details.
            2. Incorporate specific, advanced technical terms related to professional photography, 3D rendering, and visual quality (e.g., Canon EOS R5, 85mm f/1.4, cinematic film grain, volumetric lighting, Octane render, RTX Global Illumination, ultra-detailed texture, depth of field, photorealistic, Rule of Thirds).
            3. Ensure the output is *only* the new, expanded prompt string. Do not include introductory phrases, explanations, or quotes.`;
            
            const payload = {
                contents: [{ parts: [{ text: simplePrompt }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
                generationConfig: {
                    temperature: 0.3 // Use low temperature for precision
                }
            };

            const response = await customFetch(EXPANDER_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            
            const result = await response.json();
            const expandedText = result.candidates?.[0]?.content?.parts?.[0]?.text;

            if (!expandedText || expandedText.trim() === '') {
                throw new Error("Prompt expansion failed: Received empty response from the AI.");
            }

            return expandedText.trim();
        }

        /**
         * Executes the image generation API call.
         */
        async function generateArt() {
            if (!basePromptEl.value.trim()) {
                showStatus('error', 'Please enter a base concept prompt.', 5000);
                return;
            }

            const shouldExpand = promptExpanderToggle.checked;
            // Only include quality keywords if NOT expanding, as the LLM will add them otherwise.
            let finalPrompt = compilePrompt(!shouldExpand); 

            // --- UI State: Loading ---
            generatedImageEl.classList.add('hidden');
            downloadBtn.classList.add('hidden'); 
            placeholderTextEl.classList.add('hidden');
            loadingIndicatorEl.classList.remove('hidden');
            statusMessageEl.classList.add('hidden');
            
            // Disable BOTH buttons and update text
            generateBtn.disabled = true;
            generateBtn.textContent = 'Preparing Art Generation...';
            generateBtnBottom.disabled = true;
            generateBtnBottom.textContent = 'Preparing Art Generation...';
            
            lastGeneratedJpgBase64Data = null; 
            
            try {
                // --- STEP 1: PROMPT EXPANSION ---
                if (shouldExpand) {
                    loadingTipEl.textContent = "Step 1/2: Prompt Expander is active. The AI is transforming your simple prompt into a professional, hyper-detailed masterpiece...";
                    try {
                        finalPrompt = await expandPromptWithGemini(finalPrompt);
                        console.log("Expanded Prompt:", finalPrompt);
                    } catch (error) {
                        console.error("Prompt Expansion Error:", error);
                        showStatus('error', `Prompt expansion failed: ${error.message}. Proceeding with the original prompt.`, 7000);
                        // If expansion fails, proceed with the original, compiled prompt.
                    }
                }


                // --- STEP 2: IMAGE GENERATION ---
                loadingTipEl.textContent = "Step 2/2: Generating Art... Using the detailed prompt to create your image. (This may take a moment)";

                const payload = {
                    instances: [
                        { prompt: finalPrompt }
                    ],
                    parameters: {
                        sampleCount: 1,
                        aspectRatio: selectedAspectRatio, 
                    }
                };

                const response = await customFetch(GENERATE_ART_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                const result = await response.json();
                const base64PngData = result?.predictions?.[0]?.bytesBase64Encoded;

                if (!base64PngData) {
                    throw new Error("No image data returned from the API. Check prompt for restricted content.");
                }

                // Convert the returned PNG Base64 to JPEG Base64
                const jpgBase64Data = await convertBase64ToJpg(base64PngData);
                lastGeneratedJpgBase64Data = jpgBase64Data; // Store for the download button

                const imageUrl = `data:image/jpeg;base64,${jpgBase64Data}`; // Use JPEG MIME type
                generatedImageEl.src = imageUrl;
                generatedImageEl.classList.remove('hidden');
                generatedImageEl.style.width = '100%';
                generatedImageEl.style.height = 'auto';

                // Ensure placeholder text is hidden
                placeholderTextEl.classList.add('hidden');

                // UPDATED SAVE INSTRUCTIONS FOR BETTER ALIGNMENT
                const saveInstructions = `
                    <div class="flex flex-col space-y-2">
                        <p class="text-xl font-bold text-green-900">🎉 Art Generated Successfully (No Watermark)!</p>
                        <p class="font-bold text-lg text-green-800">SAVE INSTRUCTIONS:</p>
                        <ul class="list-disc list-inside space-y-1 text-green-800 ml-4">
                            <li>Click the <strong class="text-green-900">DOWNLOAD IMAGE</strong> button below.</li>
                            <li>Your browser saves the file automatically. <strong class="text-green-900">Check your Downloads folder</strong> or notifications on your device!</li>
                        </ul>
                    </div>
                `;
                showStatus('success', saveInstructions, 0); // Keep this message visible permanently
                downloadBtn.classList.remove('hidden'); 

            } catch (error) {
                console.error("Art Generation Error:", error);
                showStatus('error', `Generation failed: ${error.message}. Please check your prompt and try again.`, 10000);
                
                // Show a failure placeholder image instead of the old placeholder text
                generatedImageEl.src = "https://placehold.co/600x600/161b22/c9d1d9?text=Generation+Failed";
                generatedImageEl.classList.remove('hidden');
                
                // Ensure placeholder text and download button are hidden
                placeholderTextEl.classList.add('hidden');
                downloadBtn.classList.add('hidden');

            } finally {
                // UI State: Complete
                loadingIndicatorEl.classList.add('hidden');
                
                // Re-enable BOTH buttons and reset text
                generateBtn.disabled = false;
                generateBtn.textContent = 'GENERATE AI ART';
                generateBtnBottom.disabled = false;
                generateBtnBottom.textContent = 'GENERATE AI ART';
            }
        }
        window.generateArt = generateArt; // Expose to HTML

        /**
         * Executes the Image-to-Prompt API call.
         */
        async function uploadAndGeneratePrompt() {
            const file = imageUploadEl.files[0];
            if (!file) {
                showStatus('error', 'Please select an image file to upload.', 5000);
                return;
            }

            // UI State: Loading (relies on DOM elements)
            uploadPromptBtn.disabled = true;
            uploadPromptBtn.textContent = 'Analyzing Image...';
            loadingIndicatorEl.classList.remove('hidden');
            generatedImageEl.classList.add('hidden');
            placeholderTextEl.classList.add('hidden');
            statusMessageEl.classList.add('hidden');
            loadingTipEl.textContent = "Tip: The AI is analyzing composition, style, color, and subject matter from your uploaded image.";


            try {
                const base64ImageData = await fileToBase64(file);
                
                const userQuery = "Analyze the uploaded image. Act as an expert AI prompt engineer. Generate a highly detailed, single-paragraph prompt suitable for an image generator like Midjourney or DALL-E, focusing on style, mood, lighting, and composition. The output must be ONLY the prompt text, starting with the core subject. Avoid adding any prefix like 'Prompt:'.";
                
                const payload = {
                    contents: [
                        {
                            role: "user",
                            parts: [
                                { text: userQuery },
                                {
                                    inlineData: {
                                        mimeType: file.type,
                                        data: base64ImageData
                                    }
                                }
                            ]
                        }
                    ],
                    systemInstruction: {
                         parts: [{ text: "You are an expert prompt engineer. Your task is to analyze an image and produce a detailed, artistic prompt. Do not include introductory text or explanations." }]
                    }
                };

                const response = await customFetch(GENERATE_PROMPT_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                const result = await response.json();
                const generatedText = result.candidates?.[0]?.content?.parts?.[0]?.text;

                if (!generatedText) {
                    throw new Error("Could not generate prompt from image.");
                }

                // Update the main prompt input (relies on DOM element)
                basePromptEl.value = generatedText.trim().replace(/^Prompt:\s*/i, '',); // Clean up any prefix
                showStatus('success', 'Prompt successfully generated from image! You can now generate art or refine the prompt.', 5000);

            } catch (error) {
                console.error("Image-to-Prompt Error:", error);
                showStatus('error', `Prompt generation failed: ${error.message}.`, 10000);
            } finally {
                // UI State: Complete
                loadingIndicatorEl.classList.add('hidden');
                uploadPromptBtn.disabled = false;
                uploadPromptBtn.textContent = 'Analyze Image & Generate Prompt';
                // Reset to placeholder state if no image was generated
                if (generatedImageEl.classList.contains('hidden')) {
                     placeholderTextEl.classList.remove('hidden');
                }
            }
        }
        window.uploadAndGeneratePrompt = uploadAndGeneratePrompt; // Expose to HTML


        /**
         * Function to force a direct file download using the <a> element and download attribute.
         */
        window.handleDownload = () => {
            if (lastGeneratedJpgBase64Data) {
                const imgUrl = `data:image/jpeg;base64,${lastGeneratedJpgBase64Data}`;
                const filename = `AI_Art_Forge_${Date.now()}.jpg`; // Generate a unique filename

                // Create a temporary anchor element
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = imgUrl;
                a.download = filename; // This attribute forces a download dialog/save
                
                // Append, click, and remove the element
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);

                showStatus('success', '📥 Download initiated! Please check your browser notifications or downloads folder for the file.', 7000);

            } else {
                showStatus('error', 'Image data is not ready. Please generate art first.', 7000);
            }
        };
    </script>
</body>
</html>
